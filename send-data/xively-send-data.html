<script type="text/javascript">

    var log = function() {
    if(localStorage.debug)
      console.log.apply(console.log, arguments);
    }

    // var http = document.location.protocol || "http:";
    // var path = "/api/v1/entity/user/agile!@!agile-local";
    // var host = document.location.hostname;
    // //var host = '192.168.8.61';
    // var port = '3000';
    // idmUrl = http + "//" + host + ':' + port + path;

    var http = document.location.protocol || "http:";
    var path = "/red/auth/token";
    var host = document.location.hostname;
    //var host = '192.168.8.61';
    var port = '1880';
    nodeRedUrl = http + "//" + host + ':' + port + path;
    // //Get the access token from the page url
    // var inputUrl = new URL(document.location.href);
    // //var inputUrl = new URL("http://192.168.8.61:8000/#access_token=RCc2Bi3vKmbo5MRCn5G0qJGBtkpiPKgJMeVo0CTqbANDSaP8jHWqhYOEWzXymodC&token_type=Bearer")
    // var token = inputUrl.searchParams.get("access_token");
    //
    // $.ajax({
    //   url: idmUrl,
    //   type: 'GET',
    //   // Fetch the stored token from localStorage and set in the header
    //   headers: {"Authorization": "Bearer"+token}
    // })
    // .done(function(userData)
    // {
    //     log(userData);
    // })
    //  .fail( function(xhr, textStatus, errorThrown)
    //  {
    //      log("Request failed");
    //  });
    log("Trying to fetch token with credentials")
    $.post(nodeRedUrl, {client_id:"node-red-admin", grant_type: "password", scope: "*" , username:"admin", password:"password"})

    .done(function(data)
    {
        log(data.access_token)
        nodeRedUrl = http + "//" + host + ':' + port + "/red/flows"
        $.ajax({
          url: nodeRedUrl,
          type: 'GET',
          // Fetch the stored token from localStorage and set in the header
          headers: {"Authorization": "Bearer "+data.access_token}
        })
        .done(function(userData)
        {
            log(userData);
        })
         .fail( function(xhr, textStatus, errorThrown)
         {
             log("Request failed to get flows, xhr is: "+JSON.stringify(xhr)+" textStatus is: "+textStatus+" errorThrown is: "+errorThrown);
         });
    })

    .fail( function(xhr, textStatus, errorThrown)
    {
        log("Request failed to fetch token, xhr is: "+JSON.stringify(xhr)+" textStatus is: "+textStatus+" errorThrown is: "+errorThrown);
    });



    // $.get( "http://localhost:1880/auth/login" , function(data)
    // {
    // log(data);
    // });


    RED.nodes.registerType('xively-send-data',{
        category: 'agile',
        color: '#a6bbcf',
        defaults: {
            //add validators here
            name: {value:""},
            server: {value:"", type:"xively-config"},
            //apikey: {value: "",validate: function(key){return (key.length===48)}},
	          //feedid: {value:"",validate: RED.validators.number()},
            variable: {value: ""},
            serial:{value: ""}
        },
        inputs:1,
        outputs:1,
        icon: "inject.png",
        label: function() {
            return this.name||"PushData";
        }
    });
</script>

<script type="text/x-red" data-template-name="xively-send-data">
    <p>For an active device, enter <span style="color: #ff0000; background-color: #ccffff;">FeedID</span> and <span style="background-color: #ccffff; color: #ff0000;">API Key</span>, with variable name.</p>
    <div class="form-row">
    <label for="node-input-server"><i class="fa fa-globe"></i> Server</label>
    <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
      <label for="node-input-variable"><i class="fa fa-pie-chart"></i> Variable-Name</label>
      <input type="text" id="node-input-variable" placeholder="Optical-Agile">
    </div>
    <p>Enter a unique <span style="color: #ff0000; background-color: #ccffff;">serial number</span> to register new device.</p>
    <div class="form-row">
      <label for="node-input-serial"><i class="fa fa-microchip"></i> Serial-Number</label>
      <input type="text" id="node-input-serial" placeholder="agile-XXXX">
    </div>

</script>

<script type="text/x-red" data-help-name="xively-send-data">
<p>This is a node to push data into a <em><strong>Xively feed</strong></em>. The user needs to input the following values:</p>
<p><strong>Through the Config Node</strong></p>
<p><span style="color: #ff0000; background-color: #ccffff;"><strong>feedid:</strong> </span>which defines the Feed generated from a particular device.</p>
<p><span style="color: #ff0000; background-color: #ccffff;"><strong>apikey:</strong></span> the apikey for the particular feed specified.</p>
<p><strong>Through the editor</strong></p>
<p><span style="color: #ff0000; background-color: #ccffff;"><strong>variable:</strong></span> the name of the variable to which the user wants to push the data.</p>
<p><span style="color: #ff0000; background-color: #ccffff;"><strong>serial-number:</strong></span> a unique serial number to register and activate a new device automatically.</p>
<p>The node takes the following parameters as input inside the <strong>msg.payload</strong></p>
<p><span style="background-color: #ccffff; color: #ff0000;"><strong>DeviceID: </strong></span>The ID of the device sending the data, alphanumeric</p>
<p><span style="color: #ff0000;"><strong><span style="background-color: #ccffff;">ComponentID:</span> </strong></span>The ID of the component from which the data is read, alphanumeric</p>
<p><span style="background-color: #ccffff; color: #ff0000;"><strong>LastUpdate: </strong></span>The timestamp of the data in Epoch format (seconds), number</p>
<p><span style="background-color: #ccffff; color: #ff0000;"><strong>Value: </strong></span>The value of the reading of the componenet received</p>
<p>The output of the node returns 200 for a successful post with the value of the variable or returns the error code.</p>
</script>
